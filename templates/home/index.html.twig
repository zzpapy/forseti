{% extends 'base.html.twig' %}

{% block title %}Bienvenue sur Forseti{% endblock %}

{% block page_title %}Forseti{% endblock %}
{% block page_breadcrumbs %}<li class="active">Accueil</li>{% endblock %}

{% block nav %}
    <ul class="nav navbar-right top-nav pull-right">
                <li class="dropdown alert-drp">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="zmdi zmdi-notifications top-nav-icon"></i>
                        {% if is_transaction %}
                        <span class="top-nav-icon-badge"> {{transaction_list|length}} </span>
                        {% endif %}
                    </a>
                    {% if is_transaction %}
                    <ul  class="dropdown-menu alert-dropdown" style="right:0 !important"data-dropdown-in="bounceIn" data-dropdown-out="bounceOut">
                        <li>
                            <div class="notification-box-head-wrap">
                                <span class="notification-box-head pull-left inline-block">notifications</span>
                                <a class="txt-danger pull-right clear-notifications inline-block" href="javascript:void(0)"> clear all </a>
                                <div class="clearfix"></div>
                                <hr class="light-grey-hr ma-0"/>
                            </div>
                        </li>
                        <li>
                            <div class="streamline message-nicescroll-bar">
                                <div class="sl-item">
                                    <a href="{{ path('app_charge') }}">
                                        <div class="icon bg-green">
                                            <i class="zmdi zmdi-flag"></i>
                                        </div>
                                        <div class="sl-content">
                                            <span class="inline-block capitalize-font  pull-left truncate head-notifications">Vous avez des charges à catégoriser</span>
                                            <div class="clearfix"></div>
                                        </div>
                                    </a>	
                                </div>
                                <hr class="light-grey-hr ma-0"/>
                            </div>
                        </li>
                    </ul>
                    {% endif %}
                </li>
            </ul>
{% endblock %}
{% block body %}
    <div class="col-sm-12">
        <div class="panel panel-default card-view">
            <div class="panel-heading">
                <div class="pull-left">
                    <h6 class="panel-title txt-dark">Bienvenue sur Forseti</h6>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="panel-wrapper collapse in">
                <div class="panel-body">
                    {% if render_bankin_conf %}
                        <div id="bankin_config_alert_message"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-left">
                        <h6 class="panel-title txt-dark">Répartition des charges </h6>
                    </div>
                    {% if is_transaction %}
                        <div class="pull-right blink" style="border:1px solid red; border-radius:15px; padding:0.5em">
                             <a class="link home" href="{{ path('app_charge') }}">
                              <i class="ti-alert" style="color:red"></i>Vous avez des charges à catégoriser
                             </a>
                        </div>                        
                    {% endif %}
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">
                        <div class="flot-container">
                            <div id="flot_pie_chart" class="demo-placeholder"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-left">
                        <h6 class="panel-title txt-dark">Répartition mensuelle des charges</h6>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">
                        <div class="flot-container">
                            <div id="flot_bars_chart" class="demo-placeholder"></div>
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <div id="legend_flot_bars_chart"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts_specifique %}

    {{ encore_entry_script_tags('grandin_flotchart_excanvas') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_pie') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_resize') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_time') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_stack') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_crosshair') }}
    {{ encore_entry_script_tags('grandin_flotchart_jquery_flot_tooltip') }}
    {# {{ encore_entry_script_tags('grandin_flotchart_data') }} #}

    <script type="application/javascript">
        function blink() {
            $('.blink').fadeOut(500);
            $('.blink').fadeIn(500);
        }
        setInterval(blink, 2000);

        function getRandomColor() {
            var color = Math.floor(Math.random() * 255);
            return color;
        }

        var colorType = [];
        {% for type in total_detail_per_type_per_month|keys %}
            colorType["{{ type }}"] = "rgba(" + getRandomColor() + "," + getRandomColor() + "," + getRandomColor() + ",1)";
        {% endfor %}

        /***Pie Chart***/
        if ($('#flot_pie_chart').length > 0) {
            var pie_data = [
                {% for detail in total_detail_per_type %}
                {
                    label: '{{ detail.label }} ( {{ detail.total }} € )',
                    data: {{ detail.total }},
                    color: colorType["{{ detail.label }}"],

                },
                {% endfor %}
            ];

            var pie_op = {
                series: {
                    pie: {
                        innerRadius: 0.5,
                        show: true,
                        stroke: {
                            width: 0,
                        }
                    }
                },
                legend: {
                    backgroundColor: 'transparent',
                },
                grid: {
                    hoverable: true
                },
                color: null,
                tooltip: true,
                tooltipOpts: {
                    content: "%p.0%, %s", // show percentages, rounding to 2 decimal places
                    shifts: {
                        x: 20,
                        y: 0
                    },
                    defaultTheme: false
                },
            };
            $.plot($("#flot_pie_chart"), pie_data, pie_op);
        }

        if ($('#flot_bars_chart').length > 0) {
            /*Defining Data*/
            {% for type, detail in total_detail_per_type_per_month %}
            {% set datanumer = loop.index %}
            var d{{ loop.index }} = [];
                {% for month, total in detail %}
                d{{ datanumer }}.push([{{ month }}, {{ total }}]);
                {% endfor %}
            {% endfor %}
            
            var ds = [
                {% for type in total_detail_per_type_per_month|keys %}
                {
                    label: "{{ type }}",
                    data: d{{ loop.index }},
                    bars: {
                        order: {{ loop.index }}
                    }
                },
                {% endfor %}];

            var stack = 0,
                bars = true,
                lines = true,
                steps = true;

            /*Defining Option*/
            var sales_op = {
                bars: {
                    show: true,
                    barWidth: 0.4,
                    fill: 1,
                    align: 'center'
                },
                grid: {
                    color:  '#878787',
                    hoverable: true,
                    borderWidth: 0,
                    backgroundColor: 'transparent'
                },
                series: {
                    stack: stack
                },
                legend: {
                    position: "se",
                    margin: [10, 0],
                    backgroundColor: 'transparent',
                    noColumns: 3,
                    container: $('#legend_flot_bars_chart'),
                    labelBoxBorderColor: null,
                    labelFormatter: function (label, series) {
                        // just add some space to labes
                        return '' + label + '&nbsp;&nbsp;';
                    },
                    width: 30,
                    height: 5
                },
                yaxis: {
                    font: {
                        color: '#878787'
                    },
                    ticks: [
                        [0],
                        [10000, "10k €"],
                        [20000, "20k €"],
                        [30000, "30k €"],
                        [40000, "40k €"],
                        [50000, "50k €"],
                        [60000, "60k €"],
                        [70000, "70k €"],
                        [80000, "80k €"],
                        [90000, "90k €"],
                        [100000, "100k €"],
                    ],
                },
                xaxis: {
                    ticks: [
                        [1, "Janvier"],
                        [2, "Février"],
                        [3, "Mars"],
                        [4, "Avril"],
                        [5, "Mai"],
                        [6, "Juin"],
                        [7, "Juillet"],
                        [8, "Août"],
                        [9, "Septembre"],
                        [10, "Octobre"],
                        [11, "Novenbre"],
                        [12, "Décembre"]
                    ],
                    min:0,
                    max:12,
                    font: {
                        color: '#878787'
                    }
                },
                colors: [
                        {% for type in total_detail_per_type_per_month|keys %}
                        colorType["{{ type }}"],
                        {% endfor %}

                    ],
                tooltip: true, //activate tooltip
                tooltipOpts: {
                    content: "%s : %y.0",
                    shifts: {
                        x: -30,
                        y: -50
                    }
                }
            };

            $.plot($("#flot_bars_chart"), ds, sales_op);
        }
    </script>
{% endblock %}