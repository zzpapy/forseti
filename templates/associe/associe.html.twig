{% extends 'base.html.twig' %}

{% block title %}Gestion des associés{% endblock %}

{% block page_title %}Gestion des associés{% endblock %}
{% block page_breadcrumbs %}
    <li><a href="{{ path('home') }}">Accueil</a></li>
    <li class="active">Associés</li>{% endblock %}
{% block body %}
    <div class="col-sm-12">
        {# {% for message in app.flashes('error') %} #}
            <div id="alert" class="hide alert alert-danger">
            </div>
        {# {% endfor %} #}
        {# {% for message in app.flashes('success') %} #}
            <div id="success" class="hide alert alert-success">
            </div>
        {# {% endfor %} #}
        <div class="panel panel-default card-view">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-left">
                        <h6 class="panel-title txt-dark">Récapitulatif</h6>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">
                        <div class="table-wrap ">
                            <div class="table-responsive">
                                <table class="table table-striped mb-0">
                                    <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Prénom</th>
                                        <th>janvier</th>
                                        <th>Février</th>
                                        <th>Mars</th>
                                        <th>Avril</th>
                                        <th>Mai</th>
                                        <th>Juin</th>
                                        <th>Juillet</th>
                                        <th>Août</th>
                                        <th>Septembre</th>
                                        <th>Octobre</th>
                                        <th>Novembre</th>
                                        <th>Décembre</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for user in allUsers %}
                                        <tr>
                                            <td>{{ user.lastname|capitalize }}</td>
                                            <td>{{ user.firstname|capitalize }} {% if 'ROLE_ADMIN' in user.roles %}<p
                                                        class="alert-success p-3 text-center">admin</p>{% endif %}</td>
                                            {% set admin = false %}
                                            {% set updateAdmin = "" %}
                                            {% if user.coefficientgeneral.values %}
                                                {% for coeff in user.coefficientgeneral.values %}
                                                    {% if 'ROLE_ADMIN' in user.roles %}
                                                        {% set admin = true  %}
                                                        {% set updateAdmin = "updateAdmin" %}
                                                    {% else %}
                                                        {% set admin = false  %}
                                                        {% set updateAdmin = "" %}
                                                    {% endif %}                                            
                                                    <td class="month_{{loop.index}} {{updateAdmin}}" data-admin="{{admin}}" id="user_{{user.id}}_coeff_{{loop.index}}">{{ coeff.coefficient }}</td>
                                                {% endfor %}
                                            {% else %}
                                                {% for i in 0..11 %}
                                                    {% set val = 0  %}
                                                        {% if 'ROLE_ADMIN' in user.roles %}
                                                            {% set admin = true  %}
                                                            {% set updateAdmin = "updateAdmin" %}
                                                            {% set val = 100  %}
                                                        {% else %}
                                                            {% set val = 0 %}
                                                        {% endif %}                                                
                                                        <td class="month_{{loop.index}} {{updateAdmin}}" id="user_{{user.id}}_coeff_{{loop.index}}" >{{val}}</td>
                                                {% endfor %}
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td colspan="2"><strong>Parts Restantes</strong></td>
                                        {% for user in allUsers %}
                                            {% if 'ROLE_ADMIN' in user.roles %}
                                                {% if user.coefficientgeneral.values %}
                                                    {% for coeff in user.coefficientgeneral.values %}
                                                        <td class="updateTotal"><strong >{{coeff.coefficient }}</strong></td>
                                                    {% endfor %}
                                                {% else %}
                                                    {% for i in 0..11 %}
                                                        <td class="updateTotal"><strong >100</strong></td>                                                    
                                                    {% endfor %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-heading">
                <div class="pull-left">
                    <h6 class="panel-title txt-dark">Modification des clés de répartition</h6>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="panel-wrapper collapse in">
                <div class="panel-body">
                    <p class="text-muted">Veuillez ajouter les clés de répartition pour chaque associé.</p>
                    <div class="pills-struct horizontal-pills mt-40">
                        <ul role="tablist" class="nav nav-pills" id="myTabs_10">
                            {% set tab = [] %}
                            {% for user in assoc_form_list|keys %}
                                <li{% if loop.first %} class="active" {% endif %}><a aria-expanded="true"
                                                                                     data-toggle="tab" role="tab"
                                                                                     id="tab_{{ user }}"
                                                                                     href="#content_{{ user }}">{{ allUsers[loop.index].firstname }} {{ allUsers[loop.index].lastname }}</a>
                                </li>
                                {% set index = loop.index0 %}
                                {% if tabAssoc[index] is not empty and tabAssoc[index] is defined %}
                                    {% for i in 0..tabAssoc[index]|length-1 %}
                                        {% set tab = tab|merge({(user~"_"~i):tabAssoc[index][i].coefficient}) %}
                                    {% endfor %}
                                {% else %}
                                    {% for i in 0..11 %}
                                        {% set tab = tab|merge({(user~"_"~i):""}) %}
                                    {% endfor %}

                                {% endif %}
                            {% endfor %}
                        </ul>
                        <div class="tab-content" id="myTabContent_10">
                            {% for user, assoc_form in assoc_form_list %}
                                <div id="content_{{ user }}"
                                     class="tab-pane {% if loop.first %} active in {% endif %} fade"
                                     role="tabpanel">
                                    <div class="table-responsive">
                                        {{ form_start(assoc_form, {'attr': {'id':"form_coeff_" ~ user}})}}
                                        <table>
                                            <tr>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_january,{
                                                        'label':'Janvier',
                                                        'value':tab[user~"_0"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_february,{
                                                        'label':'Février',
                                                        'value':tab[user~"_1"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_march,{
                                                        'label':'Mars',
                                                        'value':tab[user~"_2"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_april,{
                                                        'label':'Avril',
                                                        'value':tab[user~"_3"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_may,{
                                                        'label':'Mai',
                                                        'value':tab[user~"_4"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_june,{
                                                        'label':'Juin',
                                                        'value':tab[user~"_5"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_july,{
                                                        'label':'Juillet',
                                                        'value':tab[user~"_6"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_august,{
                                                        'label':'Août',
                                                        'value':tab[user~"_7"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_september,{
                                                        'label':'Septembre',
                                                        'value':tab[user~"_8"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_october,{
                                                        'label':'Octobre',
                                                        'value':tab[user~"_9"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_november,{
                                                        'label':'Novembre',
                                                        'value':tab[user~"_10"]
                                                    }) }}
                                                </td>
                                                <td>
                                                    {{ form_row(assoc_form.coefficient_december,{
                                                        'label':'Décembre',
                                                        'value':tab[user~"_11"]
                                                    }) }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <input type="hidden" name="user_id" value="{{ user }}"/>
                                                    <button type="submit" class="valid_coeff" class="btn" data-user-id="{{user}}" data-ajax-url="{{ path('app_associe')}}">Enregistrer</button>
                                                </td>
                                            </tr>
                                        </table>
                                        {{ form_end(assoc_form) }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts_specifique %}
    <script>
        $("#alert").slideDown(500, function () {
            setTimeout(function () {
                $("#alert").slideUp(500);
            }, 5000);
        });

        $("#success").slideDown(500, function () {
            setTimeout(function () {
                $("#success").slideUp(500);
            }, 5000);
        });
        $('input').keyup(function(){
                let val = $(this).val()
            if(val > 100 || val < 0){
                $(".valid_coeff").prop('disabled', true);
                $("input").prop('disabled', true);
                $(this).prop('disabled', false);
                $(this).css('border-color','red')
                $("#alert").removeClass('hide')
                $("#alert").css('z-index','1')
                $("#alert").css('position','fixed')
                $("#alert").css('width','25%')
                $("#alert").css('top','60vh')
                $("#alert").css('left','50vw')
                $("#alert").slideDown(500, function () {
                    console.log(val)
                    if(val > 100){
                        var mess ="coefficient trop élevé"
                    }
                    else{
                        mess = "coefficient inférieur à 0"
                    }
                    
                    $("#alert").html(mess)
                    setTimeout(function () {
                        $("#alert").slideUp(500)
                        $("#alert").addClass('hide')
                        $("#alert").html("")
                    }, 5000);
                });
            }
            else{
                $(".valid_coeff").prop('disabled', false);
                $("input").prop('disabled', false);
                $(this).css('border-color','')
            }
        })
    </script>
{% endblock %}